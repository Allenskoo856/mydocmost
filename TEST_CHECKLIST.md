# 多级页面导入功能测试清单

## 测试前准备
1. ✅ 运行数据库迁移: `pnpm --filter ./apps/server run migration:latest`
2. ✅ 重新生成数据库类型: `pnpm --filter ./apps/server run migration:codegen`
3. ✅ 重启开发服务器: `pnpm dev`

## 单元测试场景

### 1. 后端校验逻辑测试

#### 1.1 父页面存在性校验
- [ ] 提供不存在的 `targetParentId`，应返回 400 错误："Target parent page not found or deleted"
- [ ] 提供已删除页面的 ID，应返回 400 错误："Target parent page not found or deleted"
- [ ] 提供有效的父页面 ID，应通过校验

#### 1.2 空间一致性校验
- [ ] 提供不在同一空间的父页面 ID，应返回 400 错误："Parent page must be in the same space"
- [ ] 提供同一空间内的父页面 ID，应通过校验

#### 1.3 锁定状态校验
- [ ] 提供已锁定页面作为父页面，应返回 403 错误："Cannot import to locked page"
- [ ] 提供未锁定页面作为父页面，应通过校验

#### 1.4 权限校验
- [ ] 无空间编辑权限的用户尝试导入，应返回 403 错误
- [ ] 有空间编辑权限的用户，应允许导入

### 2. 单页导入测试

#### 2.1 导入到空间根（向后兼容）
- [ ] 不提供 `targetParentId`，导入 Markdown 文件
- [ ] 验证页面创建成功，`parentPageId` 为 `null`
- [ ] 验证页面 position 正确（在空间根最后）

#### 2.2 导入到二级页面
- [ ] 选择一个根级页面，点击"导入到此页"
- [ ] 上传 Markdown 文件
- [ ] 验证新页面的 `parentPageId` 等于目标页面 ID
- [ ] 验证新页面成为目标页面的最后一个子页面

#### 2.3 导入到三级/四级页面
- [ ] 选择一个三级页面，点击"导入到此页"
- [ ] 上传 HTML 文件
- [ ] 验证新页面正确挂载到三级页面下
- [ ] 验证页面层级关系正确

#### 2.4 Position 生成测试
- [ ] 目标页面已有多个子页，导入新页应排在最后
- [ ] 目标页面没有子页，导入新页应成为第一个子页
- [ ] 连续导入多个页面，验证 position 递增正确

### 3. ZIP 导入测试

#### 3.1 导入到空间根（向后兼容）
- [ ] 不提供 `targetParentId`，导入 Notion 导出的 ZIP
- [ ] 验证 ZIP 内部根级文件成为空间根页面
- [ ] 验证 ZIP 内部目录结构保持层级关系

#### 3.2 导入到二级页面
- [ ] 选择一个根级页面，点击"导入到此页"
- [ ] 上传包含多层目录的 Generic ZIP
- [ ] 验证 ZIP 内部的"根"文件成为目标页面的子页
- [ ] 验证 ZIP 内部子目录仍保持相对层级关系
- [ ] 验证文件任务表中的 `parent_page_id` 字段正确保存

#### 3.3 Notion 导出 ZIP 测试
- [ ] 导入 Notion 导出的 ZIP 到三级页面
- [ ] 验证 Notion ID 被正确剥离
- [ ] 验证附件被正确处理
- [ ] 验证页面标题提取正确

#### 3.4 Confluence 导出 ZIP 测试（企业版）
- [ ] 导入 Confluence 导出的 ZIP 到二级页面
- [ ] 验证层级关系保持正确
- [ ] 验证附件和链接转换正确

#### 3.5 占位页面测试
- [ ] 上传仅包含目录无对应文件的 ZIP
- [ ] 验证为空目录创建占位页面
- [ ] 验证占位页面标题为目录名

### 4. 前端 UI 测试

#### 4.1 菜单显示测试
- [ ] 在非只读空间，页面菜单应显示"导入到此页"选项
- [ ] 在只读空间，页面菜单不应显示"导入到此页"选项
- [ ] 菜单项图标为 `IconFileImport`

#### 4.2 导入弹窗测试
- [ ] 点击"导入到此页"，弹窗正常打开
- [ ] 弹窗标题为"Import pages"
- [ ] 所有导入格式按钮正常显示（Markdown, HTML, Notion, Confluence, Generic ZIP）

#### 4.3 文件上传测试
- [ ] 选择 Markdown 文件，上传进度正常显示
- [ ] 上传成功后显示成功通知
- [ ] 上传失败显示错误信息

#### 4.4 ZIP 导入轮询测试
- [ ] 上传 ZIP 文件后，显示"Importing pages"通知
- [ ] 轮询任务状态（每 3 秒）
- [ ] 导入成功后显示"Import complete"通知
- [ ] 导入失败显示错误原因

#### 4.5 树刷新测试
- [ ] 单页导入成功后，树数据更新（根刷新）
- [ ] ZIP 导入成功后，触发 `refetchRootTreeNodeEvent`
- [ ] 验证新导入的页面可以在树中看到（可能需要手动展开父节点）

### 5. 边界条件测试

#### 5.1 文件大小限制
- [ ] 单页导入超过 10MB，应返回 413 错误
- [ ] ZIP 导入超过配置的 `FILE_IMPORT_SIZE_LIMIT`，应返回 413 错误

#### 5.2 文件格式校验
- [ ] 上传非 .md/.html 文件到单页导入，应返回 400 错误："Invalid import file type"
- [ ] 上传非 .zip 文件到 ZIP 导入，应返回 400 错误："Invalid import file extension"
- [ ] ZIP source 不是 generic/notion/confluence，应返回 400 错误

#### 5.3 空文件/空 ZIP
- [ ] 上传空 Markdown 文件，验证创建页面行为
- [ ] 上传空 ZIP，验证不报错或合理提示

#### 5.4 特殊字符处理
- [ ] 文件名包含特殊字符（emoji, Unicode），验证正确处理
- [ ] 目录名包含特殊字符，验证层级关系正确

#### 5.5 并发导入
- [ ] 同时导入多个文件到同一父页面，验证 position 不冲突
- [ ] 多个用户同时导入到不同父页面，验证互不干扰

### 6. 数据完整性测试

#### 6.1 页面字段验证
- [ ] 验证导入页面的 `spaceId` 正确
- [ ] 验证导入页面的 `workspaceId` 正确
- [ ] 验证导入页面的 `creatorId` 正确
- [ ] 验证导入页面的 `parentPageId` 正确
- [ ] 验证导入页面的 `position` 正确

#### 6.2 关联数据验证
- [ ] ZIP 导入后，验证 backlinks 表数据正确
- [ ] 验证附件关联正确
- [ ] 验证页面事件触发（PAGE_CREATED）

#### 6.3 事务回滚测试
- [ ] ZIP 导入中途失败，验证已插入数据回滚
- [ ] 数据库约束违反，验证事务回滚

### 7. 性能测试

#### 7.1 大量页面导入
- [ ] 导入包含 100+ 个文件的 ZIP，验证处理时间合理
- [ ] 验证内存占用不会过高
- [ ] 验证日志输出进度（每 50 个页面）

#### 7.2 深层嵌套测试
- [ ] 导入 10+ 层嵌套的目录结构，验证正确处理
- [ ] 验证层级计算（BFS）性能

#### 7.3 并发任务测试
- [ ] 多个 ZIP 导入任务同时处理，验证队列正常工作
- [ ] 验证 Redis 锁机制正常

## 集成测试场景

### 1. 完整流程测试
- [ ] 创建空间 → 创建根页 → 导入 Markdown 到根页 → 验证二级页创建 → 导入 ZIP 到二级页 → 验证三级层级正确

### 2. 权限流转测试
- [ ] 页面导入 → 修改父页面权限 → 验证子页继承权限

### 3. 删除关联测试
- [ ] 导入页面到父页 → 删除父页 → 验证子页级联删除
- [ ] 导入任务记录 → 删除关联页面 → 验证 `parent_page_id` 设为 null

## 回归测试

### 1. 原有功能不受影响
- [ ] 空间侧边栏的"Import pages"仍正常工作（导入到根）
- [ ] 导出功能不受影响
- [ ] 页面移动功能不受影响
- [ ] 页面复制功能不受影响

### 2. 向后兼容性
- [ ] 不提供 `targetParentId` 时，行为与之前一致
- [ ] 旧的导入任务记录（无 `parent_page_id`）仍可查询

## 测试数据准备

### 测试文件清单
1. **simple.md**: 简单 Markdown 文件，包含标题和段落
2. **with-heading.html**: HTML 文件，包含 H1 标题
3. **notion-export.zip**: Notion 导出的示例 ZIP
4. **nested-structure.zip**: 包含多层目录的 Generic ZIP
5. **large-file.md**: 接近 10MB 的 Markdown 文件
6. **special-chars-文件名.md**: 文件名包含特殊字符
7. **empty.md**: 空 Markdown 文件
8. **attachments.zip**: 包含附件的 ZIP

### 测试空间/页面准备
- 测试空间 A：用于标准测试
- 测试空间 B：用于跨空间校验测试
- 锁定页面：用于锁定状态校验
- 多层级页面：根 → 二级 → 三级 → 四级

## 问题排查清单

如果测试失败，检查以下项：
1. ✅ 数据库迁移是否成功运行
2. ✅ 数据库类型定义是否已重新生成
3. ✅ 后端服务是否重启
4. ✅ 前端服务是否重启
5. ✅ Redis 是否正常运行
6. ✅ 文件任务队列是否正常工作
7. ✅ 浏览器控制台是否有报错
8. ✅ 网络请求是否成功（查看 Network 面板）
9. ✅ 后端日志是否有错误信息

## 测试结果记录

| 测试场景 | 状态 | 备注 |
|---------|------|------|
| 后端校验逻辑 | ⏳ 待测试 | |
| 单页导入到根 | ⏳ 待测试 | |
| 单页导入到二级 | ⏳ 待测试 | |
| ZIP 导入到根 | ⏳ 待测试 | |
| ZIP 导入到二级 | ⏳ 待测试 | |
| 前端 UI 显示 | ⏳ 待测试 | |
| 轮询机制 | ⏳ 待测试 | |
| 边界条件 | ⏳ 待测试 | |
| 性能测试 | ⏳ 待测试 | |
| 回归测试 | ⏳ 待测试 | |

---

**测试建议**：
1. 先运行单元测试，确保基础功能正常
2. 再运行集成测试，验证完整流程
3. 最后进行性能和边界条件测试
4. 记录所有发现的问题并及时修复
